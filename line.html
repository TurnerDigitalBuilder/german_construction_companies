<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Construction Companies Data (2011-2023)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
        }

        #sidebar {
            width: 300px;
            background-color: #f0f0f0;
            padding: 10px;
            box-sizing: border-box;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        #sidebar h2,
        h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        #chart {
            width: calc(100% - 300px);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        svg {
            width: 90%;
            height: 70vh;
        }

        .axis-label {
            font-size: 12px;
            fill: #333;
        }

        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 12px;
            display: none;
            pointer-events: none;
            z-index: 10;
        }

        select {
            width: 100%;
            height: 400px;
            overflow: auto;
        }

        /* Link to switch pages */
        #page-switcher {
            position: absolute;
            top: 10px;
            right: 20px;
        }

        #page-switcher a {
            font-size: 16px;
            text-decoration: none;
            color: blue;
        }

        #page-switcher {
            /* position: relative; Ensure it's positioned */
            z-index: 1000;
            /* Set a high z-index to ensure it's above other layers */
        }
    </style>
</head>

<body>

    <!-- Link to switch to the Scatter Plot page -->
    <div id="page-switcher">
        <a href="scatter.html">Go to Scatter Plot</a>
    </div>

    <div id="sidebar">
        <h2>Select Companies (CAGR, Avg Revenue)</h2>
        <select id="companySelect" multiple></select>
        <button id="clearButton">Clear</button>
        <button id="sortCAGRButton">Sort by CAGR</button>
        <button id="sortRevenueButton">Sort by Avg Revenue</button>

        <h3>Toggle Performance Lines</h3>
        <label><input type="checkbox" id="toggleGerman" checked> German Performance</label><br>
        <label><input type="checkbox" id="toggleForeign"> Foreign Performance</label><br>
        <label><input type="checkbox" id="toggleTotal"> Total Performance</label>

        <h3>Y-Axis Scale</h3>
        <label><input type="checkbox" id="toggleLogScale"> Logarithmic Scale</label><br>
    </div>

    <div id="chart">
        <svg></svg>
        <div id="tooltip" class="tooltip"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch('data.json')
                .then(response => response.json())
                .then(data => {
                    window.companyData = data; // Assign the data to window.companyData for consistency
                    setupCompanySelect(window.companyData); // Initial setup
                    renderChart(window.companyData); // Initial chart rendering
                })
                .catch(error => console.error('Error loading JSON data:', error));
        });

        const startYear = 2011;
        const endYear = 2023;
        let showTotal = false;
        let showForeign = false;
        let showGerman = true; // Default to show German initially

        // Variables to track selected companies
        let selectedCompanies = new Set();

        // Event listeners for the performance checkboxes
        document.getElementById('toggleTotal').addEventListener('change', function () {
            showTotal = this.checked;
            setupCompanySelect(window.companyData); // Re-render the dropdown list
            renderChart(window.companyData); // Update the chart based on the selected performance
        });

        document.getElementById('toggleForeign').addEventListener('change', function () {
            showForeign = this.checked;
            setupCompanySelect(window.companyData); // Re-render the dropdown list
            renderChart(window.companyData); // Update the chart based on the selected performance
        });

        document.getElementById('toggleGerman').addEventListener('change', function () {
            showGerman = this.checked;
            setupCompanySelect(window.companyData); // Re-render the dropdown list
            renderChart(window.companyData); // Update the chart based on the selected performance
        });

        function setupCompanySelect(data) {
            const companySelect = document.getElementById('companySelect');
            companySelect.innerHTML = ''; // Clear existing options

            data.forEach((company) => {
                const option = document.createElement('option');
                option.value = company.Company;

                // Build revenueData similar to renderChart
                let revenueData = [];
                for (let year = startYear; year <= endYear; year++) {
                    let totalPerformance = +company.Revenue[year]?.["Total Performance (Million Euros)"];
                    let foreignPercentage = company.Revenue[year]?.["Foreign Performance (%)"];

                    if (!isNaN(totalPerformance) && totalPerformance !== null) {
                        foreignPercentage = +foreignPercentage;

                        let foreignPerformance = null;
                        let germanPerformance = null;

                        if (!isNaN(foreignPercentage) && foreignPercentage !== null) {
                            foreignPerformance = totalPerformance * (foreignPercentage / 100);
                            germanPerformance = totalPerformance * ((100 - foreignPercentage) / 100);
                        }

                        revenueData.push({
                            year: year,
                            totalPerformance: totalPerformance,
                            foreignPerformance: foreignPerformance,
                            germanPerformance: germanPerformance
                        });
                    }
                }

                // Function to calculate CAGR and average revenue for a given performance type
                function calculateCAGRAndAverage(performanceType) {
                    let filteredData = revenueData.filter(d => {
                        let value = d[performanceType];
                        return value !== null && !isNaN(value) && value > 0;
                    });

                    if (filteredData.length < 2) {
                        return { cagr: null, avgRevenue: null };
                    }

                    let firstYearData = filteredData[0];
                    let lastYearData = filteredData[filteredData.length - 1];
                    let numberOfYears = lastYearData.year - firstYearData.year;

                    if (numberOfYears <= 0) {
                        return { cagr: null, avgRevenue: null };
                    }

                    let sumRevenue = filteredData.reduce((sum, d) => sum + d[performanceType], 0);
                    let avgRevenue = sumRevenue / filteredData.length;

                    let cagr = calculateCAGR(firstYearData[performanceType], lastYearData[performanceType], numberOfYears);

                    return { cagr: cagr, avgRevenue: avgRevenue };
                }

                let selectedCAGR = "N/A";
                let selectedAverageRevenue = "N/A";

                const formatCAGR = (value) => (typeof value === 'number' && !isNaN(value)) ? value.toFixed(2) : "N/A";
                const formatRevenue = (value) => (typeof value === 'number' && !isNaN(value)) ? value.toLocaleString() : "N/A";

                if (showGerman) {
                    let { cagr, avgRevenue } = calculateCAGRAndAverage("germanPerformance");
                    selectedCAGR = formatCAGR(cagr);
                    selectedAverageRevenue = formatRevenue(avgRevenue);
                } else if (showForeign) {
                    let { cagr, avgRevenue } = calculateCAGRAndAverage("foreignPerformance");
                    selectedCAGR = formatCAGR(cagr);
                    selectedAverageRevenue = formatRevenue(avgRevenue);
                } else if (showTotal) {
                    let { cagr, avgRevenue } = calculateCAGRAndAverage("totalPerformance");
                    selectedCAGR = formatCAGR(cagr);
                    selectedAverageRevenue = formatRevenue(avgRevenue);
                }

                // Update the option text
                option.textContent = `${company.Company} (${selectedCAGR}%, €${selectedAverageRevenue})`;
                companySelect.appendChild(option);
            });

            // Add event listeners
            companySelect.addEventListener('change', function () {
                selectedCompanies.clear();
                Array.from(this.selectedOptions).forEach(option => selectedCompanies.add(option.value));
                renderChart(window.companyData);
            });

            document.getElementById('clearButton').addEventListener('click', function () {
                selectedCompanies.clear();
                Array.from(companySelect.options).forEach(option => option.selected = false);
                renderChart(window.companyData);
            });

            // Sorting event listeners
            document.getElementById('sortCAGRButton').addEventListener('click', function () {
                sortCompanies('cagr');
            });

            document.getElementById('sortRevenueButton').addEventListener('click', function () {
                sortCompanies('avgRevenue');
            });

            function sortCompanies(criteria) {
                // Get selected performance type
                let performanceType = showGerman ? "germanPerformance" :
                    showForeign ? "foreignPerformance" :
                        showTotal ? "totalPerformance" : null;

                if (!performanceType) return; // Exit if no performance type is selected

                // Sort the data
                window.companyData.sort((a, b) => {
                    const aStats = calculateCAGRAndAverage(a, performanceType);
                    const bStats = calculateCAGRAndAverage(b, performanceType);

                    if (criteria === 'cagr') {
                        return (bStats.cagr || 0) - (aStats.cagr || 0); // Sort by CAGR descending
                    } else if (criteria === 'avgRevenue') {
                        return (bStats.avgRevenue || 0) - (aStats.avgRevenue || 0); // Sort by Avg Revenue descending
                    }
                });

                setupCompanySelect(window.companyData); // Re-render the sorted list
            }

            function calculateCAGRAndAverage(company, performanceType) {
                // Use the existing logic for calculating CAGR and Avg Revenue
                let revenueData = []; // Build revenueData from company.Revenue similarly to the renderChart function
                for (let year = startYear; year <= endYear; year++) {
                    let totalPerformance = +company.Revenue[year]?.["Total Performance (Million Euros)"];
                    let foreignPercentage = company.Revenue[year]?.["Foreign Performance (%)"];

                    if (!isNaN(totalPerformance) && totalPerformance !== null) {
                        foreignPercentage = +foreignPercentage;

                        let foreignPerformance = null;
                        let germanPerformance = null;

                        if (!isNaN(foreignPercentage) && foreignPercentage !== null) {
                            foreignPerformance = totalPerformance * (foreignPercentage / 100);
                            germanPerformance = totalPerformance * ((100 - foreignPercentage) / 100);
                        }

                        revenueData.push({
                            year: year,
                            totalPerformance: totalPerformance,
                            foreignPerformance: foreignPerformance,
                            germanPerformance: germanPerformance
                        });
                    }
                }

                return calculateCAGRAndAverageForType(revenueData, performanceType);
            }

            function calculateCAGRAndAverageForType(revenueData, performanceType) {
                // Existing logic for calculating CAGR and Average Revenue
                let filteredData = revenueData.filter(d => d[performanceType] !== null && !isNaN(d[performanceType]) && d[performanceType] > 0);
                if (filteredData.length < 2) {
                    return { cagr: null, avgRevenue: null };
                }

                let firstYearData = filteredData[0];
                let lastYearData = filteredData[filteredData.length - 1];
                let numberOfYears = lastYearData.year - firstYearData.year;

                if (numberOfYears <= 0) {
                    return { cagr: null, avgRevenue: null };
                }

                let sumRevenue = filteredData.reduce((sum, d) => sum + d[performanceType], 0);
                let avgRevenue = sumRevenue / filteredData.length;

                let cagr = calculateCAGR(firstYearData[performanceType], lastYearData[performanceType], numberOfYears);

                return { cagr: cagr, avgRevenue: avgRevenue };
            }
        }


        function calculateCAGR(startValue, endValue, years) {
            if (startValue <= 0 || endValue <= 0 || years <= 0) return null;

            const cagr = (Math.pow(endValue / startValue, 1 / years) - 1) * 100;
            return (isFinite(cagr) && !isNaN(cagr)) ? cagr : null;
        }


        function renderChart(data) {
    const svg = d3.select("svg"),
        width = svg.node().getBoundingClientRect().width,
        height = window.innerHeight * 0.7,
        margin = { top: 50, right: 300, bottom: 50, left: 50 };

    // Clear existing content
    svg.selectAll("*").remove();

    // Setup scales (the axes will be drawn regardless of selection)
    const xScale = d3.scaleLinear()
        .domain([startYear, endYear])
        .range([margin.left, width - margin.right]);

    const xAxis = d3.axisBottom(xScale).ticks(endYear - startYear).tickFormat(d3.format("d"));

    svg.append("g")
        .attr("transform", `translate(0, ${height - margin.bottom})`)
        .call(xAxis)
        .append("text")
        .attr("x", width / 2)
        .attr("y", 40)
        .attr("fill", "black")
        .text("Year")
        .attr("class", "axis-label");

    // Calculate average revenues for each performance type
    const averageRevenues = { german: null, foreign: null, total: null };

    // Only calculate averages if the respective performance type is selected
    if (showGerman) {
        let germanRevenues = [];

        data.forEach(company => {
            for (let year = startYear; year <= endYear; year++) {
                let totalPerformance = +company.Revenue[year]?.["Total Performance (Million Euros)"];
                let foreignPercentage = +company.Revenue[year]?.["Foreign Performance (%)"];

                if (!isNaN(totalPerformance) && !isNaN(foreignPercentage)) {
                    let germanPerformance = totalPerformance * ((100 - foreignPercentage) / 100);
                    if (!isNaN(germanPerformance) && germanPerformance > 0) {
                        germanRevenues.push(germanPerformance);
                    }
                }
            }
        });

        if (germanRevenues.length > 0) {
            averageRevenues.german = d3.mean(germanRevenues);
        }
    }

    if (showForeign) {
        let foreignRevenues = [];

        data.forEach(company => {
            for (let year = startYear; year <= endYear; year++) {
                let totalPerformance = +company.Revenue[year]?.["Total Performance (Million Euros)"];
                let foreignPercentage = +company.Revenue[year]?.["Foreign Performance (%)"];

                if (!isNaN(totalPerformance) && !isNaN(foreignPercentage)) {
                    let foreignPerformance = totalPerformance * (foreignPercentage / 100);
                    if (!isNaN(foreignPerformance) && foreignPerformance > 0) {
                        foreignRevenues.push(foreignPerformance);
                    }
                }
            }
        });

        if (foreignRevenues.length > 0) {
            averageRevenues.foreign = d3.mean(foreignRevenues);
        }
    }

    if (showTotal) {
        let totalRevenues = [];

        data.forEach(company => {
            for (let year = startYear; year <= endYear; year++) {
                let totalPerformance = +company.Revenue[year]?.["Total Performance (Million Euros)"];

                if (!isNaN(totalPerformance) && totalPerformance > 0) {
                    totalRevenues.push(totalPerformance);
                }
            }
        });

        if (totalRevenues.length > 0) {
            averageRevenues.total = d3.mean(totalRevenues);
        }
    }

    // Determine yMax and yMin based on selected performance types and average revenues
    let yValues = [];

    data.forEach(company => {
        for (let year = startYear; year <= endYear; year++) {
            let totalPerformance = +company.Revenue[year]?.["Total Performance (Million Euros)"];
            let foreignPercentage = +company.Revenue[year]?.["Foreign Performance (%)"];
            let values = [];

            if (showTotal && !isNaN(totalPerformance) && totalPerformance > 0) values.push(totalPerformance);
            if (showForeign && !isNaN(totalPerformance) && !isNaN(foreignPercentage)) {
                let foreignPerformance = totalPerformance * (foreignPercentage / 100);
                if (foreignPerformance > 0) values.push(foreignPerformance);
            }
            if (showGerman && !isNaN(totalPerformance) && !isNaN(foreignPercentage)) {
                let germanPerformance = totalPerformance * ((100 - foreignPercentage) / 100);
                if (germanPerformance > 0) values.push(germanPerformance);
            }

            yValues = yValues.concat(values);
        }
    });

    // Include average revenues in yValues
    Object.values(averageRevenues).forEach(avgRev => {
        if (avgRev !== null && avgRev > 0) yValues.push(avgRev);
    });

    // Filter out zero or negative values for log scale
    yValues = yValues.filter(v => v > 0);

    const yMax = d3.max(yValues) || 1; // Default to 1 if no data
    const yMin = d3.min(yValues) || 1; // Default to 1 if no data

    const useLogScale = document.getElementById('toggleLogScale').checked;

    // Adjust yMin for logarithmic scale
    const minYValue = useLogScale ? yMin : 0;

    const yScale = useLogScale ?
        d3.scaleLog().domain([minYValue, yMax]).range([height - margin.bottom, margin.top]) :
        d3.scaleLinear().domain([minYValue, yMax]).range([height - margin.bottom, margin.top]);

    const yAxis = useLogScale ?
        d3.axisLeft(yScale).ticks(10, y => y.toLocaleString()) :
        d3.axisLeft(yScale).ticks(10);

    svg.append("g")
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(yAxis)
        .append("text")
        .attr("x", -height / 2)
        .attr("y", -40)
        .attr("transform", "rotate(-90)")
        .attr("fill", "black")
        .text("Revenue (Million €)")
        .attr("class", "axis-label");

    // Draw horizontal average lines
    if (averageRevenues.german !== null && averageRevenues.german > 0) {
        svg.append("line")
            .attr("x1", xScale(startYear))
            .attr("x2", xScale(endYear))
            .attr("y1", yScale(averageRevenues.german))
            .attr("y2", yScale(averageRevenues.german))
            .attr("stroke", "blue")
            .attr("stroke-dasharray", "5,5");

        svg.append("text")
            .attr("x", xScale(endYear) + 10)
            .attr("y", yScale(averageRevenues.german))
            .attr("fill", "blue")
            .attr("alignment-baseline", "middle")
            .text(`Avg German Revenue: €${Math.round(averageRevenues.german).toLocaleString()}`);
    }

    if (averageRevenues.foreign !== null && averageRevenues.foreign > 0) {
        svg.append("line")
            .attr("x1", xScale(startYear))
            .attr("x2", xScale(endYear))
            .attr("y1", yScale(averageRevenues.foreign))
            .attr("y2", yScale(averageRevenues.foreign))
            .attr("stroke", "green")
            .attr("stroke-dasharray", "5,5");

        svg.append("text")
            .attr("x", xScale(endYear) + 10)
            .attr("y", yScale(averageRevenues.foreign))
            .attr("fill", "green")
            .attr("alignment-baseline", "middle")
            .text(`Avg Foreign Revenue: €${Math.round(averageRevenues.foreign).toLocaleString()}`);
    }

    if (averageRevenues.total !== null && averageRevenues.total > 0) {
        svg.append("line")
            .attr("x1", xScale(startYear))
            .attr("x2", xScale(endYear))
            .attr("y1", yScale(averageRevenues.total))
            .attr("y2", yScale(averageRevenues.total))
            .attr("stroke", "red")
            .attr("stroke-dasharray", "5,5");

        svg.append("text")
            .attr("x", xScale(endYear) + 10)
            .attr("y", yScale(averageRevenues.total))
            .attr("fill", "red")
            .attr("alignment-baseline", "middle")
            .text(`Avg Total Revenue: €${Math.round(averageRevenues.total).toLocaleString()}`);
    }

    // Proceed to draw company lines if any companies are selected
    if (selectedCompanies.size === 0) {
        return;
    }

    const filteredData = data.filter(company => selectedCompanies.has(company.Company));

    if (filteredData.length === 0) return;

    let companyDataList = filteredData.map(company => {
        let revenueData = [];
        for (let year = startYear; year <= endYear; year++) {
            let totalPerformance = +company.Revenue[year]?.["Total Performance (Million Euros)"];
            let foreignPercentage = +company.Revenue[year]?.["Foreign Performance (%)"];

            if (!isNaN(totalPerformance) && totalPerformance > 0) {
                let foreignPerformance = null;
                let germanPerformance = null;

                if (!isNaN(foreignPercentage)) {
                    foreignPerformance = totalPerformance * (foreignPercentage / 100);
                    germanPerformance = totalPerformance * ((100 - foreignPercentage) / 100);
                }

                revenueData.push({
                    year: year,
                    totalPerformance: totalPerformance,
                    foreignPerformance: foreignPerformance > 0 ? foreignPerformance : null,
                    germanPerformance: germanPerformance > 0 ? germanPerformance : null
                });
            }
        }
        return {
            company: company.Company,
            revenueData: revenueData,
            color: company.Color
        };
    });

    const lineGenerators = {
        totalPerformance: d3.line()
            .defined(d => d.totalPerformance !== null && !isNaN(d.totalPerformance))
            .x(d => xScale(d.year))
            .y(d => yScale(d.totalPerformance)),
        foreignPerformance: d3.line()
            .defined(d => d.foreignPerformance !== null && !isNaN(d.foreignPerformance))
            .x(d => xScale(d.year))
            .y(d => yScale(d.foreignPerformance)),
        germanPerformance: d3.line()
            .defined(d => d.germanPerformance !== null && !isNaN(d.germanPerformance))
            .x(d => xScale(d.year))
            .y(d => yScale(d.germanPerformance))
    };

    const tooltip = d3.select("#tooltip");

    companyDataList.forEach((company, i) => {
        const revenueData = company.revenueData;

        // Function to calculate CAGR for a given performance type
        function calculateCAGRForPerformance(performanceType) {
            let filteredData = revenueData.filter(d => {
                let value = d[performanceType];
                return value !== null && !isNaN(value) && value > 0;
            });

            if (filteredData.length < 2) {
                return null;
            }

            let firstYearData = filteredData[0];
            let lastYearData = filteredData[filteredData.length - 1];
            let numberOfYears = lastYearData.year - firstYearData.year;

            if (numberOfYears <= 0) {
                return null;
            }

            let cagr = calculateCAGR(firstYearData[performanceType], lastYearData[performanceType], numberOfYears);

            return {
                cagr: cagr,
                data: filteredData
            };
        }

        // Draw German Performance line if enabled
        if (showGerman) {
            let result = calculateCAGRForPerformance("germanPerformance");
            if (result !== null) {
                let cagrGerman = result.cagr !== null ? parseFloat(result.cagr.toFixed(2)) : null;
                let data = result.data;

                // Draw line
                svg.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", company.color)
                    .attr("stroke-width", 1.5)
                    .attr("d", lineGenerators.germanPerformance);

                // Add dots and tooltips
                svg.selectAll(`circle.german-point-${i}`)
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("class", `german-point-${i}`)
                    .attr("cx", d => xScale(d.year))
                    .attr("cy", d => yScale(d.germanPerformance))
                    .attr("r", 4)
                    .attr("fill", company.color)
                    .attr("stroke", "white")
                    .attr("stroke-width", 1)
                    .on("mouseover", function (event, d) {
                        const [x] = d3.pointer(event, svg.node());
                        tooltip.style("display", "block")
                            .html(`<strong>Company:</strong> ${company.company}<br>
<strong>Year:</strong> ${d.year}<br>
<strong>German Performance (Million Euros):</strong> €${d.germanPerformance.toLocaleString()}`)
                            .style("left", (x + 100) + "px")
                            .style("top", (event.pageY - 15) + "px");
                    })
                    .on("mousemove", function (event) {
                        const [x] = d3.pointer(event, svg.node());
                        tooltip.style("left", (x + 100) + "px")
                            .style("top", (event.pageY - 15) + "px");
                    })
                    .on("mouseout", function () {
                        tooltip.style("display", "none");
                    });

                // Add the company name and CAGR at the end of the German Performance line
                svg.append("text")
                    .attr("x", xScale(data[data.length - 1].year) + 15)
                    .attr("y", yScale(data[data.length - 1].germanPerformance))
                    .attr("fill", company.color)
                    .attr("alignment-baseline", "middle")
                    .text(`${company.company} German (${cagrGerman !== null ? cagrGerman + '%' : 'N/A'})`);
            }
        }

        // Draw Foreign Performance line if enabled
        if (showForeign) {
            let result = calculateCAGRForPerformance("foreignPerformance");
            if (result !== null) {
                let cagrForeign = result.cagr !== null ? parseFloat(result.cagr.toFixed(2)) : null;
                let data = result.data;

                // Draw line
                svg.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", company.color)
                    .attr("stroke-width", 1.5)
                    .attr("stroke-dasharray", "4 4")
                    .attr("d", lineGenerators.foreignPerformance);

                // Add dots and tooltips
                svg.selectAll(`circle.foreign-point-${i}`)
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("class", `foreign-point-${i}`)
                    .attr("cx", d => xScale(d.year))
                    .attr("cy", d => yScale(d.foreignPerformance))
                    .attr("r", 4)
                    .attr("fill", company.color)
                    .attr("stroke", "white")
                    .attr("stroke-width", 1)
                    .on("mouseover", function (event, d) {
                        const [x] = d3.pointer(event, svg.node());
                        tooltip.style("display", "block")
                            .html(`<strong>Company:</strong> ${company.company}<br>
<strong>Year:</strong> ${d.year}<br>
<strong>Foreign Performance (Million Euros):</strong> €${d.foreignPerformance.toLocaleString()}`)
                            .style("left", (x + 100) + "px")
                            .style("top", (event.pageY - 15) + "px");
                    })
                    .on("mousemove", function (event) {
                        const [x] = d3.pointer(event, svg.node());
                        tooltip.style("left", (x + 100) + "px")
                            .style("top", (event.pageY - 15) + "px");
                    })
                    .on("mouseout", function () {
                        tooltip.style("display", "none");
                    });

                // Add the company name and CAGR at the end of the Foreign Performance line
                svg.append("text")
                    .attr("x", xScale(data[data.length - 1].year) + 15)
                    .attr("y", yScale(data[data.length - 1].foreignPerformance))
                    .attr("fill", company.color)
                    .attr("alignment-baseline", "middle")
                    .attr("opacity", 0.7)
                    .text(`${company.company} Foreign (${cagrForeign !== null ? cagrForeign + '%' : 'N/A'})`);
            }
        }

        // Draw Total Performance line if enabled
        if (showTotal) {
            let result = calculateCAGRForPerformance("totalPerformance");
            if (result !== null) {
                let cagrTotal = result.cagr !== null ? parseFloat(result.cagr.toFixed(2)) : null;
                let data = result.data;

                // Draw line
                svg.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", company.color)
                    .attr("stroke-width", 1.5)
                    .attr("stroke-dasharray", "6 2 2 2")
                    .attr("opacity", 0.5)
                    .attr("d", lineGenerators.totalPerformance);

                // Add dots and tooltips
                svg.selectAll(`circle.total-point-${i}`)
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("class", `total-point-${i}`)
                    .attr("cx", d => xScale(d.year))
                    .attr("cy", d => yScale(d.totalPerformance))
                    .attr("r", 4)
                    .attr("fill", company.color)
                    .attr("stroke", "white")
                    .attr("stroke-width", 1)
                    .on("mouseover", function (event, d) {
                        const [x] = d3.pointer(event, svg.node());
                        tooltip.style("display", "block")
                            .html(`<strong>Company:</strong> ${company.company}<br>
<strong>Year:</strong> ${d.year}<br>
<strong>Total Performance (Million Euros):</strong> €${d.totalPerformance.toLocaleString()}`)
                            .style("left", (x + 100) + "px")
                            .style("top", (event.pageY - 15) + "px");
                    })
                    .on("mousemove", function (event) {
                        const [x] = d3.pointer(event, svg.node());
                        tooltip.style("left", (x + 100) + "px")
                            .style("top", (event.pageY - 15) + "px");
                    })
                    .on("mouseout", function () {
                        tooltip.style("display", "none");
                    });

                // Add the company name and CAGR at the end of the Total Performance line
                svg.append("text")
                    .attr("x", xScale(data[data.length - 1].year) + 15)
                    .attr("y", yScale(data[data.length - 1].totalPerformance))
                    .attr("fill", company.color)
                    .attr("alignment-baseline", "middle")
                    .text(`${company.company} (${cagrTotal !== null ? cagrTotal + '%' : 'N/A'})`);
            }
        }
    });
}



        // Event listener for the log scale toggle
        document.getElementById('toggleLogScale').addEventListener('change', function () {
            renderChart(window.companyData); // Redraw the chart when the scale toggle changes
        });
    </script>
</body>

</html>